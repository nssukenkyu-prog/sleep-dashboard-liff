<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SLEEP AI KEDO</title>
  
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
  
  <style>
    :root {
      --gradient-start: #8b5cf6;
      --gradient-end: #ec4899;
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      --text-primary: #ffffff;
      --text-secondary: #cbd5e1;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
      min-height: 100vh;
      color: var(--text-primary);
      padding: 20px;
      overflow-x: hidden;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      background: var(--glass-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); border-radius: 20px;
      padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow);
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; gap: 15px;
    }
    .header h1 {
      font-size: 24px; font-weight: 700;
      background: linear-gradient(45deg, #fff, #f1f5f9);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .btn {
      background: var(--glass-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); border-radius: 12px;
      padding: 10px 20px; color: var(--text-primary);
      font-size: 14px; font-weight: 500; cursor: pointer;
      transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;
    }
    .btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
    /* ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ */
    .score-card {
      background: var(--glass-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); border-radius: 20px;
      padding: 30px; margin-bottom: 20px; box-shadow: var(--shadow); text-align: center;
    }
    .score-value {
      font-size: 72px; font-weight: 700;
      background: linear-gradient(45deg, #10b981, #14b8a6);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      line-height: 1; margin: 20px 0;
    }
    .score-label { font-size: 18px; color: var(--text-secondary); margin-bottom: 10px; }
    .badge { display: inline-block; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; margin-top: 10px; }
    .badge.success { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid #10b981; }
    .badge.warning { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid #f59e0b; }
    .badge.danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }
    /* çµ±è¨ˆãƒœãƒƒã‚¯ã‚¹ */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .stat-box {
      background: var(--glass-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); border-radius: 20px;
      padding: 25px; box-shadow: var(--shadow); transition: all 0.3s ease;
    }
    .stat-box:hover { transform: translateY(-5px); }
    .stat-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .stat-value { font-size: 32px; font-weight: 700; color: var(--text-primary); }
    /* ã‚°ãƒ©ãƒ• */
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .chart-container {
      background: var(--glass-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); border-radius: 20px;
      padding: 25px; box-shadow: var(--shadow);
    }
    .chart-title { font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 20px; }
    .chart-wrapper { position: relative; height: 300px; }
    /* ã‚¤ãƒ³ã‚µã‚¤ãƒˆ */
    .insights-container {
      background: var(--glass-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); border-radius: 20px;
      padding: 25px; margin-bottom: 20px; box-shadow: var(--shadow);
    }
    .insight-item {
      display: flex; align-items: start; gap: 15px; padding: 15px;
      background: rgba(255, 255, 255, 0.05); border-radius: 12px; margin-bottom: 12px;
    }
    .insight-icon { font-size: 24px; flex-shrink: 0; }
    .insight-text { font-size: 15px; color: var(--text-secondary); line-height: 1.6; }
    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .action-buttons { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
    .action-btn {
      flex: 1; min-width: 200px; background: var(--glass-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px;
      color: var(--text-primary); font-size: 16px; font-weight: 600; cursor: pointer;
      transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .action-btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-3px); }
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 1000;
      align-items: center; justify-content: center; padding: 20px;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.95) 0%, rgba(236, 72, 153, 0.95) 100%);
      backdrop-filter: blur(20px); border: 1px solid var(--glass-border);
      border-radius: 24px; padding: 30px; max-width: 600px; width: 100%;
      max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .modal-title { font-size: 24px; font-weight: 700; color: var(--text-primary); }
    .modal-close {
      background: rgba(255, 255, 255, 0.2); border: none; border-radius: 50%;
      width: 36px; height: 36px; font-size: 24px; color: var(--text-primary); cursor: pointer;
    }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
    .form-control {
      width: 100%; background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px;
      padding: 12px 16px; color: var(--text-primary); font-size: 16px;
    }
    .form-control option { background: #1e293b; color: #fff; }
    .modal-footer { display: flex; gap: 10px; justify-content: flex-end; }
    .btn-primary {
      background: linear-gradient(135deg, #10b981, #14b8a6); color: white; border: none;
      padding: 12px 24px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.2); color: white;
      border: 1px solid rgba(255, 255, 255, 0.3); padding: 12px 24px;
      border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;
    }
    .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(255, 255, 255, 0.2); transition: 0.4s; border-radius: 34px;
    }
    .toggle-slider:before {
      position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px;
      background-color: white; transition: 0.4s; border-radius: 50%;
    }
    input:checked + .toggle-slider { background-color: #10b981; }
    input:checked + .toggle-slider:before { transform: translateX(26px); }
    
    /* æ¯”è¼ƒCSS */
    .compare-header { display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 20px; }
    .compare-date { text-align: center; font-size: 18px; font-weight: 600; }
    .compare-row { display: grid; grid-template-columns: 1fr auto auto auto; gap: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 12px; align-items: center; }
    .compare-diff { padding: 4px 12px; border-radius: 8px; font-weight: 600; font-size: 14px; text-align: center; }
    .compare-diff.positive { background: rgba(16,185,129,0.2); color: #10b981; }
    .compare-diff.negative { background: rgba(239,68,68,0.2); color: #ef4444; }
    
    .loading { text-align: center; padding: 60px 20px; }
    .loading-spinner {
      width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.2);
      border-top: 4px solid var(--text-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error { background: rgba(239,68,68,0.2); border: 1px solid #ef4444; border-radius: 12px; padding: 20px; color: #ef4444; text-align: center; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>SLEEP AI Dashboard</h1>
      <div class="header-actions">
        <button class="btn" id="datePickerBtn">ğŸ“… æ—¥ä»˜ã®é¸æŠ</button>
        <button class="btn" id="refreshBtn">ğŸ”„ æ›´æ–°</button>
      </div>
    </header>
    
    <div id="debugPanel" style="background: rgba(0,0,0,0.7); border: 2px solid #10b981; border-radius: 16px; padding: 20px; margin-bottom: 20px; max-height: 200px; overflow-y: auto;">
      <h3 style="color: #10b981; margin: 0 0 10px 0; font-size: 14px;">ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
      <div id="debugInfo" style="font-family: monospace; font-size: 12px; color: #cbd5e1;"></div>
    </div>
    
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
    </div>
    
    <div id="error" class="error hidden"></div>
    
    <div id="dashboard" class="hidden">
      <div class="score-card">
        <div class="score-label">ç¡çœ ã‚¹ã‚³ã‚¢</div>
        <div class="score-value" id="sleepScore">0</div>
        <span class="badge" id="scoreBadge">-</span>
      </div>
      
      <div class="stats-grid">
        <div class="stat-box"><div class="stat-label">â° ç·ç¡çœ æ™‚é–“</div><div class="stat-value" id="totalSleep">--</div></div>
        <div class="stat-box"><div class="stat-label">ğŸŒ™ æ·±ã„ç¡çœ </div><div class="stat-value" id="deepSleep">--</div></div>
        <div class="stat-box"><div class="stat-label">ğŸ’“ HRV</div><div class="stat-value" id="hrvValue">--</div></div>
        <div class="stat-box"><div class="stat-label">âœ¨ ç¡çœ åŠ¹ç‡</div><div class="stat-value" id="efficiency">--</div></div>
        <div class="stat-box"><div class="stat-label">ğŸ”¥ é€£ç¶šé”æˆ</div><div class="stat-value" id="streak"><span>0</span>æ—¥</div></div>
      </div>
      
      <div class="charts-grid">
        <div class="chart-container"><div class="chart-title">ğŸ“Š ç¡çœ ã‚¹ãƒ†ãƒ¼ã‚¸</div><div class="chart-wrapper"><canvas id="sleepStagesChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">ğŸ’“ HRV & å¿ƒæ‹æ•°</div><div class="chart-wrapper"><canvas id="hrvChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">ğŸ¯ ç¡çœ åŠ¹ç‡</div><div class="chart-wrapper"><canvas id="radarChart"></canvas></div></div>
        <div class="chart-container"><div class="chart-title">ğŸ“ˆ ç›®æ¨™é”æˆç‡</div><div class="chart-wrapper"><canvas id="goalChart"></canvas></div></div>
      </div>
      
      <div class="insights-container">
        <div class="insights-title">ğŸ’¡ ä»Šæ—¥ã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</div>
        <div id="insights"></div>
      </div>
      
      <div class="action-buttons">
        <button class="action-btn" id="exportBtn">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button class="action-btn" id="compareBtn">ğŸ”„ æ¯”è¼ƒ</button>
        <button class="action-btn" id="settingsBtn">âš™ï¸ è¨­å®š</button>
      </div>
    </div>
  </div>

  <div id="exportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><div class="modal-title">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div><button class="modal-close">&times;</button></div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">å½¢å¼</label>
          <select class="form-control" id="exportFormat"><option value="csv">CSV</option></select>
        </div>
        <div class="form-group">
          <label class="form-label">æœŸé–“</label>
          <select class="form-control" id="exportPeriod">
            <option value="7">éå»7æ—¥é–“</option><option value="30">éå»30æ—¥é–“</option><option value="all">å…¨æœŸé–“</option>
          </select>
        </div>
      </div>
      <div class="modal-footer"><button class="btn-secondary modal-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn-primary" onclick="executeExport()">å®Ÿè¡Œ</button></div>
    </div>
  </div>

  <div id="compareModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><div class="modal-title">æ—¥ä»˜æ¯”è¼ƒ</div><button class="modal-close">&times;</button></div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">æ—¥ä»˜1</label><input type="text" class="form-control" id="compareDate1"></div>
        <div class="form-group"><label class="form-label">æ—¥ä»˜2</label><input type="text" class="form-control" id="compareDate2"></div>
        <div id="compareResult" class="hidden"></div>
      </div>
      <div class="modal-footer"><button class="btn-secondary modal-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn-primary" onclick="executeCompare()">æ¯”è¼ƒ</button></div>
    </div>
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><div class="modal-title">è¨­å®š</div><button class="modal-close">&times;</button></div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">ç›®æ¨™ç¡çœ æ™‚é–“(åˆ†)</label><input type="number" class="form-control" id="goalMinutesInput" step="30"></div>
        <div class="form-group"><label class="form-label">ãƒ†ãƒ¼ãƒ</label><select class="form-control" id="themeSelect"><option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option><option value="blue">ãƒ–ãƒ«ãƒ¼</option><option value="green">ã‚°ãƒªãƒ¼ãƒ³</option><option value="orange">ã‚ªãƒ¬ãƒ³ã‚¸</option></select></div>
      </div>
      <div class="modal-footer"><button class="btn-secondary modal-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn-primary" onclick="saveSettings()">ä¿å­˜</button></div>
    </div>
  </div>

  <script>
    // è¨­å®š
    const LIFF_ID = '2008504578-mqGQ6Kal';
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyf1eOUlh0PC8BBx-nxN-kecxzErv3GG3yav9-mV4M0dm3cJ9Zf2s0aR17U_LOzQ3IF/exec';

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentUserId = null;
    let currentDate = new Date();
    let dashboardData = null;
    let charts = {};
    let userSettings = { goalMinutes: 420, theme: 'default', notificationsEnabled: true, notificationTime: '08:00' };

    function debugLog(msg) {
      const div = document.getElementById('debugInfo');
      const time = new Date().toLocaleTimeString();
      div.innerHTML += `<div>[${time}] ${msg}</div>`;
      div.scrollTop = div.scrollHeight;
      console.log(`[DEBUG] ${msg}`);
    }

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      debugLog('ğŸš€ ã‚¢ãƒ—ãƒªèµ·å‹•é–‹å§‹');
      // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³è¨­å®š
      document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', (e) => e.target.closest('.modal').classList.remove('active'));
      });
      
      initializeLiff();
      setupEventListeners();
    });

    async function initializeLiff() {
      try {
        debugLog('LIFFåˆæœŸåŒ–ä¸­...');
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          debugLog('æœªãƒ­ã‚°ã‚¤ãƒ³ -> ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸');
          liff.login();
          return;
        }
        
        const profile = await liff.getProfile();
        currentUserId = profile.userId;
        debugLog(`ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${profile.displayName}`);
        
        setupDatePicker();
        loadDashboard();
      } catch (error) {
        debugLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        showError('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    async function loadDashboard(date = null) {
      showLoading();
      try {
        const targetDate = date || formatDate(currentDate);
        debugLog(`ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­: ${targetDate}`);
        
        const url = `${GAS_URL}?action=getDashboardDataV2&userId=${currentUserId}&date=${targetDate}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (!data.success) throw new Error(data.error || 'ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—');
        
        dashboardData = data;
        debugLog('ãƒ‡ãƒ¼ã‚¿å—ä¿¡æˆåŠŸ -> æç”»');
        renderDashboard(data);
        hideLoading();
      } catch (error) {
        debugLog(`âŒ ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        showError('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—: ' + error.message);
        hideLoading();
      }
    }

    function renderDashboard(data) {
      document.getElementById('dashboard').classList.remove('hidden');
      renderScore(data.today);
      renderStats(data.today);
      
      // ã‚¹ãƒˆãƒªãƒ¼ã‚¯
      const streak = data.streak || 0;
      const streakEl = document.getElementById('streak').querySelector('span');
      streakEl.textContent = streak;
      
      renderCharts(data);
      renderInsights(data);
    }

    function renderScore(data) {
      if (!data || !data.totalSleep) {
        document.getElementById('sleepScore').textContent = '0';
        return;
      }
      
      let score = 0;
      const hours = data.totalSleep / 60;
      if (hours >= 7) score += 40; else if (hours >= 6) score += 30; else score += 10;
      
      const deepPct = (data.deepSleep / data.totalSleep) * 100;
      if (deepPct >= 20) score += 30; else if (deepPct >= 10) score += 20; else score += 10;
      
      if (data.hrv >= 60) score += 20; else if (data.hrv >= 20) score += 10;
      if (data.efficiency >= 85) score += 10;
      
      const finalScore = Math.min(100, Math.round(score));
      document.getElementById('sleepScore').textContent = finalScore;
      
      const badge = document.getElementById('scoreBadge');
      if (finalScore >= 80) { badge.textContent = 'å„ªç§€'; badge.className = 'badge success'; }
      else if (finalScore >= 60) { badge.textContent = 'è‰¯å¥½'; badge.className = 'badge warning'; }
      else { badge.textContent = 'è¦æ”¹å–„'; badge.className = 'badge danger'; }
    }

    function renderStats(data) {
      document.getElementById('totalSleep').textContent = data.totalSleep ? `${(data.totalSleep/60).toFixed(1)}æ™‚é–“` : '--';
      document.getElementById('deepSleep').textContent = data.deepSleep ? `${data.deepSleep}åˆ†` : '--';
      document.getElementById('hrvValue').textContent = data.hrv ? `${data.hrv} ms` : '--';
      document.getElementById('efficiency').textContent = data.efficiency ? `${data.efficiency}%` : '--';
    }

    function renderCharts(data) {
      // ç ´æ£„
      Object.values(charts).forEach(c => c.destroy());
      charts = {};
      
      // 1. ã‚¹ãƒ†ãƒ¼ã‚¸
      const history = data.history || [];
      const labels = history.map(d => formatDateShort(d.date));
      
      charts.sleepStages = new Chart(document.getElementById('sleepStagesChart'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'æ·±ã„', data: history.map(d=>d.deepSleep), backgroundColor: '#10b981' },
            { label: 'REM', data: history.map(d=>d.remSleep), backgroundColor: '#8b5cf6' },
            { label: 'æµ…ã„', data: history.map(d=>d.lightSleep), backgroundColor: '#f59e0b' }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { x: { stacked: true, ticks: {color:'#fff'} }, y: { stacked: true, ticks: {color:'#fff'} } },
          plugins: { legend: {labels:{color:'#fff'}} }
        }
      });

      // 2. HRV
      charts.hrv = new Chart(document.getElementById('hrvChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'HRV', data: history.map(d=>d.hrv), borderColor: '#10b981', tension: 0.4
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { x: {ticks:{color:'#fff'}}, y: {ticks:{color:'#fff'}} },
          plugins: { legend: {labels:{color:'#fff'}} }
        }
      });

      // 3. ãƒ¬ãƒ¼ãƒ€ãƒ¼
      const quality = calculateQuality(data.today);
      charts.radar = new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
          labels: ['æ™‚é–“', 'æ·±ã„', 'REM', 'HRV', 'åŠ¹ç‡'],
          datasets: [{
            label: 'ã‚¹ã‚³ã‚¢', data: Object.values(quality),
            borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.3)'
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { r: { min: 0, max: 100, ticks: {display: false}, grid: {color:'rgba(255,255,255,0.2)'}, pointLabels: {color:'#fff'} } },
          plugins: { legend: {display: false} }
        }
      });

      // 4. ç›®æ¨™
      const goal = data.goalMinutes || 420;
      const current = data.today.totalSleep || 0;
      charts.goal = new Chart(document.getElementById('goalChart'), {
        type: 'doughnut',
        data: {
          labels: ['é”æˆ', 'æ®‹ã‚Š'],
          datasets: [{
            data: [current, Math.max(0, goal - current)],
            backgroundColor: ['#10b981', 'rgba(255,255,255,0.1)'], borderWidth: 0
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: {position:'bottom', labels:{color:'#fff'}} }
        }
      });
    }

    function calculateQuality(d) {
      if(!d) return {t:0, d:0, r:0, h:0, e:0};
      return {
        t: Math.min(100, ((d.totalSleep/60)/8)*100),
        d: Math.min(100, ((d.deepSleep/d.totalSleep)/0.2)*100),
        r: Math.min(100, ((d.remSleep/d.totalSleep)/0.25)*100),
        h: Math.min(100, (d.hrv/60)*100),
        e: Math.min(100, (d.efficiency/85)*100)
      };
    }

    function renderInsights(data) {
      const div = document.getElementById('insights');
      let html = '';
      if(data.today.totalSleep >= (data.goalMinutes||420)) html += '<div class="insight-item">ğŸ¯ ç›®æ¨™é”æˆï¼</div>';
      if(data.streak >= 3) html += `<div class="insight-item">ğŸ”¥ ${data.streak}æ—¥é€£ç¶šé”æˆä¸­</div>`;
      if(data.today.hrv >= 60) html += '<div class="insight-item">ğŸ’š ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³è‰¯å¥½</div>';
      if(html === '') html = '<div class="insight-item">ğŸ’¤ è¨˜éŒ²ã‚’ç¶šã‘ã¾ã—ã‚‡ã†</div>';
      div.innerHTML = html;
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    function showLoading() { document.getElementById('loading').classList.remove('hidden'); document.getElementById('dashboard').classList.add('hidden'); }
    function hideLoading() { document.getElementById('loading').classList.add('hidden'); }
    function showError(msg) { document.getElementById('error').classList.remove('hidden'); document.getElementById('error').textContent = msg; hideLoading(); }
    function formatDate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function formatDateShort(s) { const d=new Date(s); return `${d.getMonth()+1}/${d.getDate()}`; }

    function setupDatePicker() {
      flatpickr('#datePickerBtn', {
        locale: 'ja', dateFormat: 'Y-m-d', defaultDate: currentDate, maxDate: 'today',
        onChange: (d) => { currentDate = d[0]; loadDashboard(formatDate(d[0])); }
      });
      // æ¯”è¼ƒç”¨
      flatpickr('#compareDate1', { locale: 'ja', dateFormat: 'Y-m-d', maxDate: 'today' });
      flatpickr('#compareDate2', { locale: 'ja', dateFormat: 'Y-m-d', maxDate: 'today' });
    }

    function setupEventListeners() {
      document.getElementById('refreshBtn').addEventListener('click', () => loadDashboard());
      document.getElementById('exportBtn').addEventListener('click', () => document.getElementById('exportModal').classList.add('active'));
      document.getElementById('compareBtn').addEventListener('click', () => {
        document.getElementById('compareModal').classList.add('active');
        setupDatePicker(); // å†è¨­å®š
      });
      document.getElementById('settingsBtn').addEventListener('click', () => document.getElementById('settingsModal').classList.add('active'));
    }
    
    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
    function executeExport() {
      if(!dashboardData) return;
      const data = dashboardData.history;
      const csv = ['æ—¥ä»˜,ç¡çœ æ™‚é–“(åˆ†),æ·±ã„ç¡çœ (åˆ†),HRV'].join(',') + '\n' +
        data.map(d => `${d.date},${d.totalSleep},${d.deepSleep},${d.hrv}`).join('\n');
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'sleep_data.csv'; a.click();
      document.getElementById('exportModal').classList.remove('active');
    }

    // æ¯”è¼ƒæ©Ÿèƒ½
    async function executeCompare() {
      const d1 = document.getElementById('compareDate1').value;
      const d2 = document.getElementById('compareDate2').value;
      if(!d1 || !d2) return alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
      
      showLoading();
      try {
        const [r1, r2] = await Promise.all([
          fetch(`${GAS_URL}?action=getDashboardDataV2&userId=${currentUserId}&date=${d1}`).then(r=>r.json()),
          fetch(`${GAS_URL}?action=getDashboardDataV2&userId=${currentUserId}&date=${d2}`).then(r=>r.json())
        ]);
        
        const resDiv = document.getElementById('compareResult');
        resDiv.classList.remove('hidden');
        resDiv.innerHTML = `
          <div class="compare-header"><div>${d1}</div><div>vs</div><div>${d2}</div></div>
          <div class="compare-row"><div>ç¡çœ æ™‚é–“</div><div>${r1.today.totalSleep}åˆ†</div><div class="compare-diff">${r1.today.totalSleep - r2.today.totalSleep}</div><div>${r2.today.totalSleep}åˆ†</div></div>
          <div class="compare-row"><div>HRV</div><div>${r1.today.hrv}</div><div class="compare-diff">${r1.today.hrv - r2.today.hrv}</div><div>${r2.today.hrv}</div></div>
        `;
        hideLoading();
      } catch(e) {
        showError('æ¯”è¼ƒã‚¨ãƒ©ãƒ¼');
      }
    }

    // è¨­å®šä¿å­˜
    function saveSettings() {
      const goal = document.getElementById('goalMinutesInput').value;
      fetch(`${GAS_URL}?action=setGoal&userId=${currentUserId}&goalMinutes=${goal}`);
      document.getElementById('settingsModal').classList.remove('active');
      loadDashboard();
    }
  </script>
</body>
</html>
