<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SLEEP AI KEDO</title>
  
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Outfit:wght@500;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #6366f1;   /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ï¼ˆç´«ç³»ï¼‰ */
      --secondary: #10b981; /* æˆåŠŸè‰²ï¼ˆç·‘ç³»ï¼‰ */
      --accent: #f43f5e;    /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼ˆèµ¤ãƒ”ãƒ³ã‚¯ç³»ï¼‰ */
      --bg-color: #f8fafc;  /* èƒŒæ™¯è‰²ï¼ˆè–„ã„ã‚°ãƒ¬ãƒ¼ï¼‰ */
      --card-bg: #ffffff;   /* ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ï¼ˆç™½ï¼‰ */
      --text-main: #1e293b; /* æ–‡å­—è‰²ï¼ˆæ¿ƒã„ã‚°ãƒ¬ãƒ¼ï¼‰ */
      --text-sub: #64748b;  /* ã‚µãƒ–æ–‡å­—è‰² */
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Outfit', 'Noto Sans JP', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      padding-bottom: 40px; /* ä¸‹éƒ¨ã®ä½™ç™½ */
    }

    .container {
      max-width: 800px; /* ã‚¹ãƒãƒ›ã€œã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå‘ã‘ã«å¹…ã‚’åˆ¶é™ */
      margin: 0 auto;
      padding: 20px;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼å‘¨ã‚Š */
    .header {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 24px;
    }

    .header h1 {
      font-size: 22px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 0.5px;
    }

    .header-controls {
      display: flex;
      gap: 10px;
      background: var(--card-bg);
      padding: 8px;
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    /* ãƒœã‚¿ãƒ³é¡ã®ãƒ‡ã‚¶ã‚¤ãƒ³ä¿®æ­£ */
    .control-btn {
      flex: 1;
      border: none;
      background: #f1f5f9;
      color: var(--text-main);
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .control-btn:active { transform: scale(0.96); }
    .control-btn.primary { background: var(--primary); color: white; }

    /* ãƒ¡ã‚¤ãƒ³ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ */
    .hero-card {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 30px 20px;
      text-align: center;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .hero-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
    }

    .score-title { font-size: 14px; color: var(--text-sub); font-weight: 600; margin-bottom: 5px; }
    
    .score-display {
      font-size: 64px;
      font-weight: 800;
      line-height: 1;
      margin: 10px 0;
      color: var(--text-main);
      font-family: 'Outfit', sans-serif;
    }

    .badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      background: #f1f5f9;
    }
    .badge.success { background: #d1fae5; color: #059669; }
    .badge.warning { background: #fef3c7; color: #d97706; }
    .badge.danger { background: #fee2e2; color: #dc2626; }

    /* çµ±è¨ˆã‚°ãƒªãƒƒãƒ‰ï¼ˆ2åˆ—è¡¨ç¤ºï¼‰ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* 2åˆ—å›ºå®š */
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-item {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label { font-size: 12px; color: var(--text-sub); font-weight: 600; }
    .stat-value { font-size: 20px; font-weight: 700; color: var(--text-main); }
    
    /* ã‚°ãƒ©ãƒ•ã‚«ãƒ¼ãƒ‰ */
    .chart-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }

    .chart-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 16px;
      font-weight: 700;
      color: var(--text-main);
    }

    .chart-wrapper {
      position: relative;
      height: 220px; /* é«˜ã•ã‚’å›ºå®šã—ã¦é–“å»¶ã³é˜²æ­¢ */
      width: 100%;
    }

    /* ã‚¤ãƒ³ã‚µã‚¤ãƒˆ */
    .insights-area {
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      border-radius: 20px;
      padding: 20px;
      color: white;
      margin-bottom: 24px;
      box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
    }
    .insight-row { display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-start; }
    .insight-row:last-child { margin-bottom: 0; }
    .insight-icon { background: rgba(255,255,255,0.2); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

    /* ä¸‹éƒ¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .action-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .action-mini-btn {
      background: var(--card-bg);
      border: 1px solid #e2e8f0;
      padding: 12px 5px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-sub);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }
    .action-mini-btn span { font-size: 18px; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå¾®èª¿æ•´ï¼‰ */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; align-items: flex-end; }
    .modal.active { display: flex; }
    .modal-content {
      background: white;
      width: 100%;
      border-radius: 24px 24px 0 0; /* ä¸‹ã‹ã‚‰å‡ºã¦ãã‚‹ã‚·ãƒ¼ãƒˆé¢¨ */
      padding: 24px;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .form-group { margin-bottom: 16px; }
    .form-control { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; background: #f8fafc; }
    .btn-block { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 10px; }
    
    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
    .hidden { display: none !important; }
    .loading { text-align: center; padding: 50px 0; color: var(--text-sub); }
    .error { background: #fee2e2; color: #dc2626; padding: 15px; border-radius: 12px; margin-bottom: 20px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    
    <header class="header">
      <h1>SLEEP AI Dashboard</h1>
      
      <div class="header-controls">
        <button class="control-btn" id="datePickerBtn">
          ğŸ“… <span id="currentDateDisplay">æ—¥ä»˜é¸æŠ</span>
        </button>
        <button class="control-btn primary" id="refreshBtn" style="flex: 0 0 50px;">
          ğŸ”„
        </button>
      </div>
    </header>

    <div id="loading" class="loading">
      èª­ã¿è¾¼ã¿ä¸­...
    </div>
    
    <div id="error" class="error hidden"></div>

    <div id="dashboard" class="hidden">
      
      <div class="hero-card">
        <div class="score-title">SLEEP SCORE</div>
        <div class="score-display" id="sleepScore">--</div>
        <div class="badge" id="scoreBadge">--</div>
      </div>

      <div id="insights" class="insights-area"></div>

      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label">â° ç¡çœ æ™‚é–“</div>
          <div class="stat-value" id="totalSleep">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ğŸŒ™ æ·±ã„ç¡çœ </div>
          <div class="stat-value" id="deepSleep">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ğŸ’“ HRV</div>
          <div class="stat-value" id="hrvValue">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ğŸ“Š åŠ¹ç‡</div>
          <div class="stat-value" id="efficiency">--</div>
        </div>
        <div class="stat-item" style="grid-column: 1 / -1;"> <div class="stat-label">ğŸ”¥ é€£ç¶šé”æˆ</div>
          <div class="stat-value" id="streak">--</div>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">ğŸ“Š ç¡çœ ã‚¹ãƒ†ãƒ¼ã‚¸</div>
        <div class="chart-wrapper"><canvas id="sleepStagesChart"></canvas></div>
      </div>

      <div class="chart-card">
        <div class="chart-header">ğŸ’“ HRV & å¿ƒæ‹æ•°</div>
        <div class="chart-wrapper"><canvas id="hrvChart"></canvas></div>
      </div>

      <div class="chart-card">
        <div class="chart-header">ğŸ¯ ç¡çœ åŠ¹ç‡ãƒãƒ©ãƒ³ã‚¹</div>
        <div class="chart-wrapper"><canvas id="radarChart"></canvas></div>
      </div>

      <div class="chart-card">
        <div class="chart-header">ğŸ“ˆ ç›®æ¨™é”æˆç‡</div>
        <div class="chart-wrapper" style="height: 200px;"><canvas id="goalChart"></canvas></div>
      </div>

      <div class="action-grid">
        <button class="action-mini-btn" id="exportBtn">
          <span>ğŸ“¥</span> ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        </button>
        <button class="action-mini-btn" id="compareBtn">
          <span>âš–ï¸</span> æ—¥ä»˜æ¯”è¼ƒ
        </button>
        <button class="action-mini-btn" id="settingsBtn">
          <span>âš™ï¸</span> è¨­å®š
        </button>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <h3 style="margin-bottom:20px;">è¨­å®š</h3>
      <div class="form-group">
        <label class="stat-label">ç›®æ¨™ç¡çœ æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
        <input type="number" class="form-control" id="goalMinutesInput" step="30">
        <p style="font-size:12px; color:#64748b; margin-top:5px;">420åˆ† = 7æ™‚é–“</p>
      </div>
      <button class="btn-block" onclick="saveSettings()">ä¿å­˜ã™ã‚‹</button>
      <button class="btn-block" style="background:transparent; color:#64748b; margin-top:0;" onclick="closeModal('settingsModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <div id="exportModal" class="modal">
    <div class="modal-content">
      <h3 style="margin-bottom:20px;">ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</h3>
      <div class="form-group">
        <label class="stat-label">æœŸé–“</label>
        <select class="form-control" id="exportPeriod">
          <option value="7">éå»7æ—¥é–“</option>
          <option value="30">éå»30æ—¥é–“</option>
          <option value="all">å…¨æœŸé–“</option>
        </select>
      </div>
      <button class="btn-block" onclick="executeExport()">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button class="btn-block" style="background:transparent; color:#64748b; margin-top:0;" onclick="closeModal('exportModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <div id="compareModal" class="modal">
    <div class="modal-content">
      <h3 style="margin-bottom:20px;">æ—¥ä»˜æ¯”è¼ƒ</h3>
      <div class="form-group">
        <label class="stat-label">æ—¥ä»˜ A</label>
        <input type="text" class="form-control" id="compareDate1" placeholder="é¸æŠã—ã¦ãã ã•ã„">
      </div>
      <div class="form-group">
        <label class="stat-label">æ—¥ä»˜ B</label>
        <input type="text" class="form-control" id="compareDate2" placeholder="é¸æŠã—ã¦ãã ã•ã„">
      </div>
      <div id="compareResult" class="hidden" style="background:#f1f5f9; padding:15px; border-radius:12px; margin-bottom:15px;"></div>
      
      <button class="btn-block" onclick="executeCompare()">æ¯”è¼ƒã™ã‚‹</button>
      <button class="btn-block" style="background:transparent; color:#64748b; margin-top:0;" onclick="closeModal('compareModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script>
    const LIFF_ID = '2008504578-mqGQ6Kal';
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyf1eOUlh0PC8BBx-nxN-kecxzErv3GG3yav9-mV4M0dm3cJ9Zf2s0aR17U_LOzQ3IF/exec';

    let currentUserId = null;
    let currentDate = new Date();
    let dashboardData = null;
    let charts = {};
    let userSettings = { goalMinutes: 420 };

    document.addEventListener('DOMContentLoaded', () => {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.querySelectorAll('.modal').forEach(m => {
        m.addEventListener('click', e => { if(e.target === m) m.classList.remove('active'); });
      });
      initializeLiff();
      setupEventListeners();
      updateDateDisplay(currentDate);
    });

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        currentUserId = profile.userId;
        
        setupDatePicker();
        loadDashboard();
      } catch (error) {
        showError('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    async function loadDashboard(date = null) {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      
      try {
        const targetDate = date || formatDate(currentDate);
        const url = `${GAS_URL}?action=getDashboardDataV2&userId=${currentUserId}&date=${targetDate}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (!data.success) throw new Error(data.error || 'ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—');
        
        dashboardData = data;
        renderDashboard(data);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
      } catch (error) {
        showError('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—: ' + error.message);
      }
    }

    function renderDashboard(data) {
      // ã‚¹ã‚³ã‚¢
      renderScore(data.today);
      
      // çµ±è¨ˆ
      const t = data.today;
      document.getElementById('totalSleep').textContent = t.totalSleep ? `${(t.totalSleep/60).toFixed(1)}æ™‚é–“` : '--';
      document.getElementById('deepSleep').textContent = t.deepSleep ? `${t.deepSleep}åˆ†` : '--';
      document.getElementById('hrvValue').textContent = t.hrv ? `${t.hrv} ms` : '--';
      document.getElementById('efficiency').textContent = t.efficiency ? `${t.efficiency}%` : '--';
      document.getElementById('streak').textContent = (data.streak || 0) + 'æ—¥é€£ç¶š';

      // ã‚°ãƒ©ãƒ•
      renderCharts(data);
      renderInsights(data);
    }

    function renderScore(data) {
      if (!data || !data.totalSleep) {
        document.getElementById('sleepScore').textContent = '0';
        return;
      }
      // ç°¡æ˜“è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
      let score = 0;
      const h = data.totalSleep / 60;
      if (h >= 7) score += 40; else if (h >= 6) score += 30; else score += 10;
      const dp = (data.deepSleep / data.totalSleep) * 100;
      if (dp >= 20) score += 30; else if (dp >= 10) score += 20;
      if (data.hrv >= 60) score += 20; else if (data.hrv >= 20) score += 10;
      if (data.efficiency >= 85) score += 10;

      const final = Math.min(100, Math.round(score));
      const el = document.getElementById('sleepScore');
      el.textContent = final;
      
      // è‰²åˆ†ã‘
      const badge = document.getElementById('scoreBadge');
      if (final >= 80) { badge.textContent = 'Great! å„ªç§€'; badge.className = 'badge success'; el.style.color = 'var(--secondary)'; }
      else if (final >= 60) { badge.textContent = 'Good è‰¯å¥½'; badge.className = 'badge warning'; el.style.color = '#d97706'; }
      else { badge.textContent = 'Bad æ”¹å–„æ¨å¥¨'; badge.className = 'badge danger'; el.style.color = 'var(--accent)'; }
    }

    function renderInsights(data) {
      const div = document.getElementById('insights');
      let html = '';
      if (data.today.totalSleep >= (data.goalMinutes || 420)) {
        html += `<div class="insight-row"><div class="insight-icon">ğŸ¯</div><div>ç›®æ¨™é”æˆã§ã™ï¼ç´ æ™´ã‚‰ã—ã„ï¼</div></div>`;
      }
      if (data.today.hrv >= 60) {
        html += `<div class="insight-row"><div class="insight-icon">ğŸ’š</div><div>HRVãŒé«˜ãã€å›å¾©çŠ¶æ…‹ãŒè‰¯ã„ã§ã™ã€‚</div></div>`;
      }
      if (html === '') html = `<div class="insight-row"><div class="insight-icon">ğŸ’¤</div><div>ä»Šå¤œã‚‚è‰¯ã„ç¡çœ ã‚’ã¨ã‚Šã¾ã—ã‚‡ã†ã€‚</div></div>`;
      div.innerHTML = html;
    }

    function renderCharts(data) {
      Object.values(charts).forEach(c => c.destroy());
      charts = {};

      const history = data.history || [];
      const labels = history.map(d => formatDateShort(d.date));

      // å…±é€šã‚ªãƒ—ã‚·ãƒ§ãƒ³
      const commonOpt = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
      };

      // 1. ã‚¹ãƒ†ãƒ¼ã‚¸
      charts.stages = new Chart(document.getElementById('sleepStagesChart'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'æ·±ã„', data: history.map(d=>d.deepSleep), backgroundColor: '#10b981' },
            { label: 'REM', data: history.map(d=>d.remSleep), backgroundColor: '#8b5cf6' },
            { label: 'æµ…ã„', data: history.map(d=>d.lightSleep), backgroundColor: '#f59e0b' }
          ]
        },
        options: { ...commonOpt, scales: { x: {stacked:true}, y: {stacked:true} } }
      });

      // 2. HRV
      charts.hrv = new Chart(document.getElementById('hrvChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{ label: 'HRV', data: history.map(d=>d.hrv), borderColor: '#10b981', tension: 0.3, fill: true, backgroundColor: 'rgba(16,185,129,0.1)' }]
        },
        options: commonOpt
      });

      // 3. ãƒ¬ãƒ¼ãƒ€ãƒ¼
      const q = calculateQuality(data.today);
      charts.radar = new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
          labels: ['æ™‚é–“', 'æ·±ã„', 'REM', 'HRV', 'åŠ¹ç‡'],
          datasets: [{
            label: 'ãƒãƒ©ãƒ³ã‚¹', data: Object.values(q),
            borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.2)', pointBackgroundColor: '#6366f1'
          }]
        },
        options: { ...commonOpt, scales: { r: { min: 0, max: 100 } } }
      });

      // 4. ç›®æ¨™
      const goal = data.goalMinutes || 420;
      const cur = data.today.totalSleep || 0;
      charts.goal = new Chart(document.getElementById('goalChart'), {
        type: 'doughnut',
        data: {
          labels: ['é”æˆ', 'æœªé”æˆ'],
          datasets: [{
            data: [cur, Math.max(0, goal-cur)],
            backgroundColor: ['#10b981', '#e2e8f0'], borderWidth: 0
          }]
        },
        options: commonOpt
      });
    }

    function calculateQuality(d) {
      if(!d) return {t:0,d:0,r:0,h:0,e:0};
      return {
        t: Math.min(100, ((d.totalSleep/60)/7.5)*100),
        d: Math.min(100, ((d.deepSleep/d.totalSleep)/0.2)*100),
        r: Math.min(100, ((d.remSleep/d.totalSleep)/0.25)*100),
        h: Math.min(100, (d.hrv/60)*100),
        e: Math.min(100, (d.efficiency/85)*100)
      };
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ç³»
    function showError(msg) {
      const err = document.getElementById('error');
      err.textContent = msg;
      err.classList.remove('hidden');
      document.getElementById('loading').classList.add('hidden');
    }
    function formatDate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function formatDateShort(s) { const d=new Date(s); return `${d.getMonth()+1}/${d.getDate()}`; }
    function updateDateDisplay(d) { document.getElementById('currentDateDisplay').textContent = formatDate(d); }

    function setupDatePicker() {
      flatpickr('#datePickerBtn', {
        locale: 'ja', dateFormat: 'Y-m-d', defaultDate: currentDate, maxDate: 'today',
        disableMobile: true, // ã‚¹ãƒãƒ›ã§ã‚‚flatpickrã®UIã‚’ä½¿ã†
        onChange: (d) => { currentDate = d[0]; updateDateDisplay(d[0]); loadDashboard(formatDate(d[0])); }
      });
      flatpickr('#compareDate1', { locale: 'ja', dateFormat: 'Y-m-d', maxDate: 'today' });
      flatpickr('#compareDate2', { locale: 'ja', dateFormat: 'Y-m-d', maxDate: 'today' });
    }

    function setupEventListeners() {
      document.getElementById('refreshBtn').addEventListener('click', () => loadDashboard());
      document.getElementById('exportBtn').addEventListener('click', () => document.getElementById('exportModal').classList.add('active'));
      document.getElementById('compareBtn').addEventListener('click', () => {
        document.getElementById('compareModal').classList.add('active');
        setupDatePicker();
      });
      document.getElementById('settingsBtn').addEventListener('click', () => document.getElementById('settingsModal').classList.add('active'));
    }

    // CSVå‡ºåŠ›
    function executeExport() {
      if(!dashboardData) return;
      const csv = ['æ—¥ä»˜,ç¡çœ æ™‚é–“(åˆ†),æ·±ã„ç¡çœ (åˆ†),HRV'].join(',') + '\n' +
        dashboardData.history.map(d => `${d.date},${d.totalSleep},${d.deepSleep},${d.hrv}`).join('\n');
      const url = URL.createObjectURL(new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' }));
      const a = document.createElement('a'); a.href = url; a.download = 'sleep_data.csv'; a.click();
      closeModal('exportModal');
    }

    // æ¯”è¼ƒå®Ÿè¡Œ
    async function executeCompare() {
      const d1 = document.getElementById('compareDate1').value;
      const d2 = document.getElementById('compareDate2').value;
      if(!d1 || !d2) return alert('æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„');
      
      const resDiv = document.getElementById('compareResult');
      resDiv.innerHTML = 'è¨ˆç®—ä¸­...';
      resDiv.classList.remove('hidden');

      try {
        const [r1, r2] = await Promise.all([
          fetch(`${GAS_URL}?action=getDashboardDataV2&userId=${currentUserId}&date=${d1}`).then(r=>r.json()),
          fetch(`${GAS_URL}?action=getDashboardDataV2&userId=${currentUserId}&date=${d2}`).then(r=>r.json())
        ]);
        
        const val1 = r1.today.totalSleep || 0;
        const val2 = r2.today.totalSleep || 0;
        const diff = val1 - val2;
        
        resDiv.innerHTML = `
          <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:10px;">
            <span>${d1}</span> <span>VS</span> <span>${d2}</span>
          </div>
          <div>ç¡çœ æ™‚é–“å·®: <span style="color:${diff>0?'var(--secondary)':'var(--accent)'}">${diff>0?'+':''}${diff}åˆ†</span></div>
          <div style="font-size:12px; color:#64748b;">${val1}åˆ† / ${val2}åˆ†</div>
        `;
      } catch(e) {
        resDiv.innerHTML = 'æ¯”è¼ƒã‚¨ãƒ©ãƒ¼';
      }
    }

    function saveSettings() {
      const g = document.getElementById('goalMinutesInput').value;
      fetch(`${GAS_URL}?action=setGoal&userId=${currentUserId}&goalMinutes=${g}`);
      closeModal('settingsModal');
      loadDashboard();
    }
  </script>
</body>
</html>
